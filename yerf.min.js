yerf=function(){var k=(new Date).getTime(),g={},j=!1,h={},c=function(a){if("string"!==typeof a)throw Error("You must specify a key for this Sample.");if(g[a])return this.onError(Error("Sample["+a+"] already exists.")),g[a];this.key=a;this.waitingFor=this.children=this.parent=this.stoppedAt=this.startedAt=this.offset=this.delta=void 0;this.state="created";g[a]=this},f={config:{},getConfig:function(a){if(this.config[a])return this.config[a];throw Error("You need to set yerf().config."+a);},usesModernPerf:performance&&
performance.timing&&"function"===typeof performance.now&&"function"===typeof performance.webkitGetEntries,Sample:c,find:function(a){return g[a]},all:function(){return g},create:function(a){return new this.Sample(a)},start:function(a){return this.create(a).start()},on:function(a,b,e){if("string"!==typeof a)throw Error("You must specify a fullKey for yerf().on().");if("string"!==typeof b)throw Error("You must specify an event for yerf().on().");if("function"!==typeof e)throw Error("You must specify a subscriber function for yerf().on().");
var d=h[a];d||(d={},h[a]=d);a=d[b];a||(a=[],d[b]=a);a.push(e)},trigger:function(a,b,e){if("string"!==typeof a)throw Error("You must specify a fullKey for yerf().trigger().");if("string"!==typeof b)throw Error("You must specify an event for yerf().trigger().");if(a=h[a])(b=a[b])&&kivi._.each(b,function(a){a(e)})},getTime:function(){return this.usesModernPerf?performance.now():(new Date).getTime()-k},clear:function(){g={};h={}},render:function(){if(!j){j=!0;var a=kivi.getConfig("$"),b=this.getConfig("viewerCssPath");
this.getConfig("viewerJsPath");a("body").append('<link href="'+b+'" rel="stylesheet">');a.getScript("../lib/waterfall_viewer.js")}}};c.prototype.fullChildKey=function(a){if(!a)throw Error("You must specify a childKey.");return this.key+"."+a};c.prototype.find=function(a){return f.find(this.fullChildKey(a))};c.prototype.on=function(a,b){if(!a)throw Error("You must specify an event for Sample.on().");f.on(this.key,a,b);return this};c.prototype.trigger=function(a){if(!a)throw Error("You must specify an event for Sample.trigger().");
f.trigger(this.key,a,this);return this};c.prototype.isWaterfalling=function(){return"number"===typeof this.offset};c.prototype.start=function(){if(0===arguments.length)if("created"===this.state)this.startedAt=f.getTime(),this.state="started",this.parent&&(this.offset=this.startedAt-this.parent.startedAt),this.trigger("start");else this.onError(Error("Sample["+this.key+"] has already started."));else kivi._.each(arguments,function(a){if(!this.waitingFor||!this.waitingFor[a])return this.onError(Error("Cannot start a child["+
a+"] you are not waiting for.")),this;var b=this.children[a];b||(b=new c(this.fullChildKey(a)));b.start()},this);return this};c.prototype.stop=function(){if(0===arguments.length)if("created"===this.state)this.onError(Error("Sample["+this.key+"] has not been started."));else if("started"===this.state){if(this.waitingFor)return this.onError(Error("Sample["+this.key+"] is a waterfall and cannot be manually stopped.")),this;this._doStop()}else this.onError(Error("Sample["+this.key+"] has already stopped."));
else kivi._.each(arguments,function(a){var b=this.children[a];if(!b)return this.onError(Error("Cannot stop a child["+a+"] that is not attached.")),this;b.stop()},this);return this};c.prototype._doStop=function(){this.stoppedAt=f.getTime();this.delta=this.stoppedAt-this.startedAt;this.state="stopped";"function"===typeof this.beforeReport&&this.beforeReport();this.parent||this._reportToKivi();this.trigger("stop")};c.prototype._reportToKivi=function(){kivi.set("yerf.delta."+this.key,this.delta);"number"===
typeof this.offset&&kivi.set("yerf.offset."+this.key,this.offset);kivi._.each(this.children,function(a){a._reportToKivi()})};c.prototype.waterfall=function(){var a=this;if("created"===this.state)this.start();else if("started"!==this.state)return this.onError(Error("Sample["+this.key+"] has already stopped.")),this;this.offset=this.offset||0;if(0<arguments.length){this.waitingFor=this.waitingFor||{};var b;this.children=this.children||{};kivi._.each(arguments,function(e){b=this.waitingFor[e];if("boolean"!==
typeof b){this.waitingFor[e]=!0;var d=this.fullChildKey(e),c=yerf(d);if(c&&"created"!=c.state)return this.onError(Error("Child["+d+"] is already started.")),this;f.on(d,"start",function(b){b.parent=a;b.offset=b.startedAt-a.startedAt;a.children[e]=b});f.on(this.fullChildKey(e),"stop",function(){a._checkStop(e)})}},this)}return this};c.prototype._checkStop=function(a){if("string"!==typeof a)throw Error("You must pass a key to _checkStop");if(!this.waitingFor)return this;this.waitingFor[a]=!1;var b=
!0;kivi._.each(this.waitingFor,function(a){!0===a&&(b=!1)});b&&this._doStop();return this};c.prototype.backfill=function(a,b,e){if("string"!==typeof a)throw Error("You must specify a key for this Sample.");if("number"!==typeof b)throw Error("You must specify a startedAt for this Sample["+a+"].");if("number"!==typeof e)throw Error("You must specify a stoppedAt for this Sample["+a+"].");if("stopped"!==this.state)return this.onError(Error("Sample["+this.key+"] must be stopped to backfill with key["+
a+"].")),this;this.children=this.children||{};var d=new c(this.fullChildKey(a));d.startedAt=b;d.stoppedAt=e;d.delta=e-b;d.state="stopped";d.offset=b-this.startedAt;0>d.offset&&(d.offset=0);d.parent=this;this.children[a]=d;this._updateBounds(b,e);return this};c.prototype.backfillRequest=function(a,b){if(!a)throw Error("You must specify a urlPattern for this Sample.");f.usesModernPerf&&kivi._.each(performance.webkitGetEntries(),function(e){var d=b,c=e.name.match(a);c&&("string"!==typeof d&&(d=c[c.length-
1]),this.backfill(d,e.startTime,e.startTime+e.duration))},this);return this};c.prototype._updateBounds=function(a,b){var c=this.startedAt-this.offset;a<this.startedAt&&(this.startedAt=a,this.delta=this.stoppedAt-this.startedAt,this.offset=a-c,0>this.offset&&(this.offset=0),kivi._.each(this.children,function(b){b.startedAt>a&&(b.offset=b.startedAt-a)}));b>this.stoppedAt&&(this.stoppedAt=b,this.delta=this.stoppedAt-this.startedAt);this.parent&&this.parent._updateBounds(a,b);return this};c.prototype.onError=
function(a){console.log(a.message)};return function(a){return a?f.find(a):f}}();

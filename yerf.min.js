yerf=function(){var k=!1,l=!1,m=!1;window.performance&&("function"===typeof performance.now&&(k=!0),performance.timing&&(l=!0),"function"===typeof performance.getEntries&&(m=!0));var n;k&&(n=performance.now());var q=(new Date).getTime(),h={},p=!1,j={},d={config:{},find:function(a){return h[a]},all:function(){return h},create:function(a){return new this.Sample(a)},start:function(a){return this.create(a).start()},on:function(a,b,c){if("string"!==typeof a)throw Error("You must specify a fullKey for yerf().on().");
if("string"!==typeof b)throw Error("You must specify an event for yerf().on().");if("function"!==typeof c)throw Error("You must specify a subscriber function for yerf().on().");var e=j[a];e||(e={},j[a]=e);a=e[b];a||(a=[],e[b]=a);a.push(c)},trigger:function(a,b,c){if("string"!==typeof a)throw Error("You must specify a fullKey for yerf().trigger().");if("string"!==typeof b)throw Error("You must specify an event for yerf().trigger().");(a=j[a])&&kivi._.each(a[b],function(a){a(c)})},hasNow:k,hasTiming:l,
hasEntries:m,oldBoot:q,modernBoot:n,getTime:function(){return this.hasNow?performance.now():(new Date).getTime()-this.oldBoot},normTime:function(a){var b=0,b=this.hasNow?a-this.oldBoot+this.modernBoot:a-this.oldBoot;0>b&&(b=0);return b},getEntries:function(){var a=[];this.hasEntries&&(a=performance.getEntries());return a},clear:function(){h={};j={}},render:function(){if(!p){p=!0;var a=kivi.getConfig("$"),b=yerf().config.waterfallViewer,c;if(b&&b.cssPath)c=b.cssPath;else throw Error("You need to set yerf().config.waterfallViewer.cssPath");
if(b&&b.jsPath)b=b.jsPath;else throw Error("You need to set yerf().config.waterfallViewer.jsPath");a("body").append('<link href="'+c+'" rel="stylesheet">');a.getScript(b,function(){yerf().render()})}},onError:function(a){kivi.log(a.message)}},f=function(a){if("string"!==typeof a)throw Error("You must specify a key for this Sample.");if(h[a])return d.onError(Error("Sample["+a+"] already exists.")),h[a];this.key=a;this.waitingFor=this.children=this.parent=this.stoppedAt=this.startedAt=this.offset=this.delta=
void 0;this.state="created";h[a]=this};f.prototype.fullChildKey=function(a){if(!a)throw Error("You must specify a childKey.");return this.key+"."+a};f.prototype.find=function(a){return d.find(this.fullChildKey(a))};f.prototype.on=function(a,b){if(!a)throw Error("You must specify an event for Sample.on().");d.on(this.key,a,b);return this};f.prototype.trigger=function(a){if(!a)throw Error("You must specify an event for Sample.trigger().");d.trigger(this.key,a,this);return this};f.prototype.start=function(){if(0===
arguments.length)if("created"===this.state)this.startedAt=d.getTime(),this.state="started",this.offset=this.startedAt,this.trigger("start");else d.onError(Error("Sample["+this.key+"] has already started."));else kivi._.each(arguments,function(a){(!this.waitingFor||!this.waitingFor[a])&&this.waterfall(a);var b=this.children[a];b||(b=new f(this.fullChildKey(a)));b.start()},this);return this};f.prototype.stop=function(){if(0===arguments.length)if("created"===this.state)d.onError(Error("Sample["+this.key+
"] has not been started."));else if("started"===this.state){if(this.waitingFor)return d.onError(Error("Sample["+this.key+"] is a waterfall and cannot be manually stopped.")),this;this._doStop()}else d.onError(Error("Sample["+this.key+"] has already stopped."));else kivi._.each(arguments,function(a){var b=this.children[a];if(!b)return d.onError(Error("Cannot stop a child["+a+"] that is not attached.")),this;b.stop()},this);return this};f.prototype._doStop=function(a){this.stoppedAt=a||d.getTime();
this.delta=this.stoppedAt-this.startedAt;this.state="stopped";"function"===typeof this.beforeReport&&this.beforeReport();this.parent||this._reportToKivi();this.trigger("stop")};f.prototype._reportToKivi=function(){kivi.set("yerf.delta."+this.key,Math.round(this.delta));kivi.set("yerf.offset."+this.key,Math.round(this.offset));kivi._.each(this.children,function(a){a._reportToKivi()})};f.prototype.waterfall=function(){var a=this;if("created"===this.state)this.start();else if("started"!==this.state)return d.onError(Error("Sample["+
this.key+"] has already stopped.")),this;0<arguments.length&&(this.waitingFor=this.waitingFor||{},this.children=this.children||{},kivi._.each(arguments,function(b){if("boolean"!==typeof this.waitingFor[b]){this.waitingFor[b]=!0;var c=this.fullChildKey(b),e=yerf(c);if(e&&"created"!==e.state)return d.onError(Error("Child["+c+"] has already started.")),this;d.on(c,"start",function(c){c.parent=a;c.offset=c.startedAt-a.startedAt;a.children[b]=c});d.on(this.fullChildKey(b),"stop",function(c){a._checkStop(b,
c.stoppedAt)})}},this));return this};f.prototype._checkStop=function(a,b){if(!this.waitingFor)return this;this.waitingFor[a]=!1;var c=!0;kivi._.each(this.waitingFor,function(a){!0===a&&(c=!1)});c&&this._doStop(b)};f.prototype.backfill=function(a,b,c,e){if("string"!==typeof b)throw Error("You must specify a key for this Sample.");if("number"!==typeof c)throw Error("You must specify a startedAt for this Sample["+b+"].");if("number"!==typeof e)throw Error("You must specify a stoppedAt for this Sample["+
b+"].");if("stopped"!==this.state)return d.onError(Error("Sample["+this.key+"] must be stopped to backfill with key["+b+"].")),this;if(this.children&&this.find(b))return d.onError(Error("Sample["+this.fullChildKey(b)+"] already exists.")),this;var g;this.children=this.children||{};a?this.find(a)?g=this.find(a):(g=new f(this.fullChildKey(a)),g.startedAt=c,g.stoppedAt=e,g.delta=e-c,g.state="stopped",g.offset=c-this.startedAt,g.children={},g.parent=this,this.children[a]=g):g=this;a=new f(g.fullChildKey(b));
a.startedAt=c;a.stoppedAt=e;a.delta=e-c;a.state="stopped";a.offset=c-g.startedAt;0>a.offset&&(a.offset=0);a.parent=g;g.children[b]=a;g.updateBounds(c,e);return this};f.prototype.backfillRequest=function(a,b,c){if(!c)throw Error("You must specify a urlPattern for this Sample.");d.hasEntries&&kivi._.each(d.getEntries(),function(e){var d=b,f=e.name.match(c);f&&("string"!==typeof d&&(d=f[f.length-1]),this.backfill(a,d,e.startTime,e.startTime+e.duration))},this);return this};f.prototype.normalizedBackfill=
function(a,b,c,e){if("number"!==typeof c)throw Error("You must specify a startedAt for this Sample["+b+"].");if("number"!==typeof e)throw Error("You must specify a stoppedAt for this Sample["+b+"].");return this.backfill(a,b,d.normTime(c),d.normTime(e))};f.prototype.updateBounds=function(a,b){var c=this.startedAt-this.offset,d=!1;a<this.startedAt&&(this.startedAt=a,this.delta=this.stoppedAt-this.startedAt,this.offset=a-c,0>this.offset&&(this.offset=0),kivi._.each(this.children,function(b){b.offset=
b.startedAt-a}),d=!0);b>this.stoppedAt&&(this.stoppedAt=b,this.delta=this.stoppedAt-this.startedAt,d=!0);!0===d&&this.parent&&this.parent.updateBounds(a,b);return this};d.Sample=f;return function(a){return a?d.find(a):d}}();
